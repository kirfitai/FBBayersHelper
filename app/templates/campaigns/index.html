{% extends "base.html" %}

{% block title %}Управление кампаниями - {{ super() }}{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .campaign-actions .btn {
        margin-right: 5px;
    }
    
    .campaign-actions .check-btn {
        background-color: #4285f4;
        border-color: #4285f4;
    }
    
    .campaign-actions .check-btn:hover {
        background-color: #3367d6;
        border-color: #3367d6;
    }
    
    .campaign-row {
        cursor: pointer;
    }
    
    .campaign-row:hover {
        background-color: #f8f9fa;
    }
    
    .campaign-details {
        display: none;
        background-color: #f8f9fa;
    }
    
    .campaign-details.active {
        display: table-row;
    }
    
    .details-container {
        padding: 15px;
    }
    
    .details-badge {
        font-size: 0.9em;
    }
    
    .toggle-icon {
        transition: transform 0.2s;
    }
    
    .toggle-icon.rotated {
        transform: rotate(90deg);
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Управление кампаниями</h1>
            <div>
                <form method="POST" action="{{ url_for('main.refresh_campaigns') }}" class="d-inline">
                    {{ form.csrf_token }}
                    <button type="submit" class="btn btn-outline-primary">Обновить список кампаний</button>
                </form>
                <a href="{{ url_for('main.assign_campaign') }}" class="btn btn-primary">Назначить кампанию</a>
            </div>
        </div>
        
        {% if not has_api_configured %}
        <div class="alert alert-warning">
            <h4 class="alert-heading">Необходимо настроить Facebook API</h4>
            <p>Для получения списка кампаний и управления ими необходимо настроить доступ к Facebook API.</p>
            <a href="{{ url_for('auth.manage_tokens') }}" class="btn btn-warning">Управление токенами</a>
        </div>
        {% endif %}
        
        {% if campaign_setups %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Назначенные кампании</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Кампания</th>
                                <th>Сетап</th>
                                <th>Интервал</th>
                                <th>Статус</th>
                                <th>Последняя проверка</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for campaign_setup in campaign_setups %}
                            <tr class="campaign-row" data-campaign-id="{{ campaign_setup.id }}">
                                <td>
                                    <span class="d-flex align-items-center">
                                        <i class="fas fa-chevron-right toggle-icon me-2"></i>
                                        {{ campaign_setup.campaign_name or campaign_setup.campaign_id }}
                                    </span>
                                </td>
                                <td>{{ campaign_setup.setup.name }}</td>
                                <td>{{ campaign_setup.setup.check_interval }} мин</td>
                                <td>
                                    {% if campaign_setup.is_active %}
                                    <span class="badge bg-success">Активна</span>
                                    {% else %}
                                    <span class="badge bg-danger">Неактивна</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if campaign_setup.last_checked %}
                                    {{ campaign_setup.last_checked.strftime('%d.%m.%Y %H:%M') }}
                                    {% else %}
                                    <span class="text-muted">Не проверялась</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm campaign-actions">
                                        <form method="POST" action="{{ url_for('main.check_campaign_setup', id=campaign_setup.id) }}" class="d-inline">
                                            {{ form.csrf_token }}
                                            <button type="submit" class="btn btn-primary check-btn" title="Принудительная проверка">
                                                <i class="fas fa-sync-alt"></i> Проверить
                                            </button>
                                        </form>
                                        <form method="POST" action="{{ url_for('main.toggle_campaign_setup', id=campaign_setup.id) }}" class="d-inline">
                                            {{ form.csrf_token }}
                                            <button type="submit" class="btn btn-warning" title="{% if campaign_setup.is_active %}Деактивировать{% else %}Активировать{% endif %} кампанию">
                                                {% if campaign_setup.is_active %}
                                                <i class="fas fa-pause"></i> Деактивировать
                                                {% else %}
                                                <i class="fas fa-play"></i> Активировать
                                                {% endif %}
                                            </button>
                                        </form>
                                        <form method="POST" action="{{ url_for('main.delete_campaign_setup', id=campaign_setup.id) }}" class="d-inline">
                                            {{ form.csrf_token }}
                                            <button type="submit" class="btn btn-danger" onclick="return confirm('Вы уверены, что хотите удалить эту кампанию?')" title="Удалить кампанию">
                                                <i class="fas fa-trash"></i> Удалить
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            <tr class="campaign-details" id="details-{{ campaign_setup.id }}">
                                <td colspan="6">
                                    <div class="details-container">
                                        <div id="campaign-report-{{ campaign_setup.id }}" class="report-container">
                                            {% if session.check_campaign_id == campaign_setup.campaign_id and session.check_details_html %}
                                                {{ session.check_details_html|safe }}
                                            {% else %}
                                                <div class="alert alert-info">
                                                    Нажмите "Проверить", чтобы увидеть отчет о проверке объявлений.
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info">
            <h4 class="alert-heading">Нет назначенных кампаний</h4>
            <p>Обновите список кампаний и назначьте им сетапы для мониторинга.</p>
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block javascript %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Обработка клика по строке кампании
        const campaignRows = document.querySelectorAll('.campaign-row');
        
        campaignRows.forEach(function(row) {
            row.addEventListener('click', function(e) {
                // Пропускаем клик, если он был по кнопке или форме
                if (e.target.closest('button') || e.target.closest('form')) {
                    return;
                }
                
                const campaignId = this.getAttribute('data-campaign-id');
                const detailsRow = document.getElementById('details-' + campaignId);
                const toggleIcon = this.querySelector('.toggle-icon');
                
                // Переключаем видимость строки с деталями
                if (detailsRow.classList.contains('active')) {
                    detailsRow.classList.remove('active');
                    toggleIcon.classList.remove('fa-chevron-down');
                    toggleIcon.classList.add('fa-chevron-right');
                } else {
                    // Закрываем все открытые строки
                    document.querySelectorAll('.campaign-details.active').forEach(function(openRow) {
                        openRow.classList.remove('active');
                        const openRowId = openRow.id.split('-')[1];
                        const openRowIcon = document.querySelector('[data-campaign-id="' + openRowId + '"] .toggle-icon');
                        if (openRowIcon) {
                            openRowIcon.classList.remove('fa-chevron-down');
                            openRowIcon.classList.add('fa-chevron-right');
                        }
                    });
                    
                    // Открываем текущую строку
                    detailsRow.classList.add('active');
                    toggleIcon.classList.remove('fa-chevron-right');
                    toggleIcon.classList.add('fa-chevron-down');
                }
            });
        });
    });
</script>
{% endblock %}