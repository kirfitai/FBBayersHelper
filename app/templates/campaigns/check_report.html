{% extends "base.html" %}

{% block title %}Проверка кампании{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .loader-container {
        display: none;
        text-align: center;
        margin: 20px 0;
    }
    .loader {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .error-message {
        display: none;
        color: #dc3545;
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #dc3545;
        border-radius: 4px;
        background-color: #f8d7da;
    }
    .results-container {
        display: none;
    }

    .status-disabled {
        background-color: #d4edda;
    }

    .status-active {
        background-color: #fff3cd;
    }

    .status-warning {
        background-color: #f8d7da;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Проверка кампании: {{ campaign.name }}</h1>
    
    <div class="card mb-4">
        <div class="card-header">
            <h5>Параметры проверки</h5>
        </div>
        <div class="card-body">
            <form id="checkForm">
                <div class="form-group row">
                    <label for="checkPeriod" class="col-sm-3 col-form-label">Период для проверки:</label>
                    <div class="col-sm-6">
                        <select class="form-control" id="checkPeriod" name="check_period">
                            <option value="today" {% if check_period == 'today' %}selected{% endif %}>Сегодня</option>
                            <option value="last2days" {% if check_period == 'last2days' %}selected{% endif %}>Последние 2 дня</option>
                            <option value="last3days" {% if check_period == 'last3days' %}selected{% endif %}>Последние 3 дня</option>
                            <option value="last7days" {% if check_period == 'last7days' %}selected{% endif %}>Последние 7 дней</option>
                            <option value="alltime" {% if check_period == 'alltime' %}selected{% endif %}>Все время</option>
                        </select>
                    </div>
                    <div class="col-sm-3">
                        <button type="submit" class="btn btn-primary" id="checkButton">
                            <i class="fas fa-sync-alt"></i> Проверить
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Индикатор загрузки -->
    <div class="loader-container" id="loaderContainer">
        <div class="loader"></div>
        <p class="mt-2">Проверка кампании, пожалуйста подождите...</p>
    </div>
    
    <!-- Сообщение об ошибке -->
    <div class="error-message" id="errorMessage"></div>
    
    <!-- Контейнер с результатами -->
    <div class="results-container" id="resultsContainer">
        <div class="card mb-4">
            <div class="card-header">
                <h5>Информация о кампании</h5>
            </div>
            <div class="card-body">
                <table class="table table-bordered">
                    <tr>
                        <th width="20%">ID кампании:</th>
                        <td>{{ campaign.campaign_id }}</td>
                    </tr>
                    <tr>
                        <th>Название:</th>
                        <td>{{ campaign.name }}</td>
                    </tr>
                    <tr>
                        <th>Статус:</th>
                        <td>{{ campaign.status }}</td>
                    </tr>
                </table>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5>Результаты проверки</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="resultsTable">
                        <thead>
                            <tr>
                                <th>ID объявления</th>
                                <th>Название</th>
                                <th>Статус</th>
                                <th>Расход</th>
                                <th>Конверсии</th>
                                <th>Причина</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if results %}
                                {% for result in results %}
                                <tr class="{% if result.action == 'disable' %}table-danger{% elif result.status == 'warning' %}table-warning{% else %}table-success{% endif %}">
                                    <td>{{ result.ad_id }}</td>
                                    <td>{{ result.name }}</td>
                                    <td>{{ result.status }}</td>
                                    <td>{{ result.spend }}</td>
                                    <td>{{ result.conversions }}</td>
                                    <td>{{ result.reason }}</td>
                                </tr>
                                {% endfor %}
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/campaign_checker.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const campaignId = '{{ campaign.campaign_id }}';
        const checkForm = document.getElementById('checkForm');
        const checkButton = document.getElementById('checkButton');
        const loaderContainer = document.getElementById('loaderContainer');
        const errorMessage = document.getElementById('errorMessage');
        const resultsContainer = document.getElementById('resultsContainer');
        
        // Показываем результаты, если они уже есть
        {% if results %}
            resultsContainer.style.display = 'block';
        {% endif %}
        
        // Обработка отправки формы
        checkForm.addEventListener('submit', function(event) {
            event.preventDefault();
            
            // Получаем выбранный период
            const checkPeriod = document.getElementById('checkPeriod').value;
            
            // Блокируем кнопку и показываем индикатор загрузки
            checkButton.disabled = true;
            loaderContainer.style.display = 'block';
            errorMessage.style.display = 'none';
            resultsContainer.style.display = 'none';
            
            // Создаем проверку кампании
            const checker = new CampaignChecker(campaignId, {
                checkPeriod: checkPeriod,
                callbacks: {
                    onStart: function() {
                        console.log('Проверка начата');
                    },
                    onSuccess: function(results) {
                        // Отображаем результаты
                        renderResultsToTable(results, '#resultsTable');
                        resultsContainer.style.display = 'block';
                    },
                    onError: function(error) {
                        // Показываем сообщение об ошибке
                        errorMessage.textContent = error.message || 'Произошла ошибка при проверке кампании';
                        errorMessage.style.display = 'block';
                    },
                    onComplete: function() {
                        // Разблокируем кнопку и скрываем индикатор загрузки
                        checkButton.disabled = false;
                        loaderContainer.style.display = 'none';
                    }
                }
            });
            
            // Запускаем проверку
            checker.check();
        });
    });
</script>
{% endblock %} 