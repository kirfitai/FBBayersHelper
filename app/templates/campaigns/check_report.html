{% extends "base.html" %}

{% block title %}Проверка кампании{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .loader-container {
        display: none;
        text-align: center;
        margin: 20px 0;
    }
    .loader {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 2s linear infinite;
        margin: 20px auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .error-message {
        display: none;
        color: #dc3545;
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #dc3545;
        border-radius: 4px;
        background-color: #f8d7da;
    }
    .results-container {
        margin-top: 20px;
    }

    .status-disabled {
        background-color: #d4edda;
    }

    .status-active {
        background-color: #fff3cd;
    }

    .status-warning {
        background-color: #f8d7da;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="my-4">Проверка кампании</h1>
    
    {% if error %}
    <div class="error-message">
        <h4>Ошибка:</h4>
        <p>{{ error }}</p>
    </div>
    {% endif %}
    
    <div class="card mb-4">
        <div class="card-header">
            <h5>Настройки проверки</h5>
        </div>
        <div class="card-body">
            <form id="checkForm" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <div class="form-group">
                    <label for="check_period">Период проверки:</label>
                    <select class="form-control" id="check_period" name="check_period">
                        <option value="today" {% if check_period == 'today' %}selected{% endif %}>Сегодня</option>
                        <option value="yesterday" {% if check_period == 'yesterday' %}selected{% endif %}>Вчера</option>
                        <option value="last_3_days" {% if check_period == 'last_3_days' %}selected{% endif %}>Последние 3 дня</option>
                        <option value="last_7_days" {% if check_period == 'last_7_days' %}selected{% endif %}>Последние 7 дней</option>
                        <option value="last_14_days" {% if check_period == 'last_14_days' %}selected{% endif %}>Последние 14 дней</option>
                        <option value="last_30_days" {% if check_period == 'last_30_days' %}selected{% endif %}>Последние 30 дней</option>
                        <option value="this_month" {% if check_period == 'this_month' %}selected{% endif %}>Этот месяц</option>
                        <option value="last_month" {% if check_period == 'last_month' %}selected{% endif %}>Прошлый месяц</option>
                    </select>
                </div>
                
                <button type="submit" class="btn btn-primary">Проверить кампанию</button>
            </form>
        </div>
    </div>
    
    <div id="loader" class="loader"></div>
    
    <div id="resultsContainer" class="results-container">
        {% if campaign %}
        <div class="card mb-4">
            <div class="card-header">
                <h5>Информация о кампании</h5>
            </div>
            <div class="card-body">
                <p><strong>ID кампании:</strong> {{ campaign.id }}</p>
                <p><strong>Название:</strong> {{ campaign.name }}</p>
                <p><strong>Статус:</strong> {{ campaign.status }}</p>
            </div>
        </div>
        {% endif %}
        
        {% if results %}
        <div class="card">
            <div class="card-header">
                <h5>Результаты проверки</h5>
            </div>
            <div class="card-body">
                <table class="table table-striped" id="resultsTable">
                    <thead>
                        <tr>
                            <th>ID объявления</th>
                            <th>Название</th>
                            <th>Статус</th>
                            <th>Расход</th>
                            <th>Конверсии</th>
                            <th>Причина</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ad in results %}
                        <tr class="{% if ad.status == 'disabled' %}table-danger{% elif ad.status == 'warning' %}table-warning{% else %}table-light{% endif %}">
                            <td>{{ ad.id }}</td>
                            <td>{{ ad.name }}</td>
                            <td>{{ ad.status }}</td>
                            <td>{{ ad.spend }}</td>
                            <td>{{ ad.conversions }}</td>
                            <td>{{ ad.reason }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/campaign_checker.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Обработка отправки формы
        document.getElementById('checkForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const campaignId = "{{ campaign_id if campaign_id else campaign.id if campaign }}";
            const checkPeriod = document.getElementById('check_period').value;
            
            // Показываем индикатор загрузки
            document.getElementById('loaderContainer').style.display = 'block';
            document.getElementById('resultsContainer').style.display = 'none';
            
            // Выполняем AJAX запрос
            fetch(`/campaigns/check/${campaignId}?check_period=${checkPeriod}`, {
                method: 'GET',
                headers: {
                    'Accept': 'text/html'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сети: ' + response.status);
                }
                return response.text();
            })
            .then(html => {
                const resultsContainer = document.getElementById('resultsContainer');
                resultsContainer.innerHTML = html;
                resultsContainer.style.display = 'block';
                
                // Если есть результаты, скрываем форму
                if (resultsContainer.querySelector('table tbody tr')) {
                    document.getElementById('checkForm').style.display = 'none';
                }
            })
            .catch(error => {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = 'Ошибка при проверке кампании: ' + error.message;
                
                const loaderContainer = document.getElementById('loaderContainer');
                loaderContainer.parentNode.insertBefore(errorDiv, loaderContainer.nextSibling);
            })
            .finally(() => {
                // Скрываем индикатор загрузки
                document.getElementById('loaderContainer').style.display = 'none';
            });
        });
    });
</script>
{% endblock %} 