{% extends "base.html" %}

{% block title %}Проверка кампании{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .loader-container {
        display: none;
        text-align: center;
        margin: 20px 0;
    }
    .loader {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 2s linear infinite;
        margin: 20px auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .error-message {
        display: none;
        color: #dc3545;
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #dc3545;
        border-radius: 4px;
        background-color: #f8d7da;
    }
    .results-container {
        margin-top: 20px;
    }

    .status-disabled {
        background-color: #d4edda;
    }

    .status-active {
        background-color: #fff3cd;
    }

    .status-warning {
        background-color: #f8d7da;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="my-4">Проверка кампании</h1>
    
    {% if error %}
    <div class="alert alert-danger">
        <h4>Ошибка:</h4>
        <p>{{ error }}</p>
    </div>
    {% endif %}
    
    <div class="card mb-4">
        <div class="card-header">
            <h5>Информация о проверке</h5>
        </div>
        <div class="card-body">
            {% if setup %}
            <p><strong>Настройка проверки:</strong> {{ setup.name }}</p>
            <p><strong>Период проверки:</strong> 
                {% if check_period == 'today' %}
                    Сегодня
                {% elif check_period == 'yesterday' %}
                    Вчера
                {% elif check_period == 'last2days' %}
                    Последние 2 дня
                {% elif check_period == 'last3days' %}
                    Последние 3 дня  
                {% elif check_period == 'last7days' %}
                    Последние 7 дней
                {% elif check_period == 'alltime' %}
                    Всё время
                {% else %}
                    {{ check_period }}
                {% endif %}
            </p>
            <p><strong>Интервал проверки:</strong> {{ setup.check_interval }} минут</p>
            {% endif %}
            
            <button type="button" id="checkButton" class="btn btn-primary">Запустить проверку</button>
        </div>
    </div>
    
    <div id="loaderContainer" class="loader-container">
        <div class="loader"></div>
        <p>Проверка кампании, пожалуйста подождите...</p>
    </div>
    
    <div id="resultsContainer" class="results-container">
        {% if campaign %}
        <div class="card mb-4">
            <div class="card-header">
                <h5>Информация о кампании</h5>
            </div>
            <div class="card-body">
                <p><strong>ID кампании:</strong> {{ campaign.id }}</p>
                <p><strong>Название:</strong> {{ campaign.name }}</p>
                <p><strong>Статус:</strong> {{ campaign.status }}</p>
            </div>
        </div>
        {% endif %}
        
        {% if results %}
        <div class="card">
            <div class="card-header">
                <h5>Результаты проверки</h5>
            </div>
            <div class="card-body">
                <table class="table table-striped" id="resultsTable">
                    <thead>
                        <tr>
                            <th>ID объявления</th>
                            <th>Название</th>
                            <th>Статус</th>
                            <th>Расход</th>
                            <th>Конверсии</th>
                            <th>Причина</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ad in results %}
                        <tr class="{% if ad.status == 'disabled' %}table-danger{% elif ad.status == 'warning' %}table-warning{% else %}table-light{% endif %}">
                            <td>{{ ad.id }}</td>
                            <td>{{ ad.name }}</td>
                            <td>{{ ad.status }}</td>
                            <td>{{ ad.spend }}</td>
                            <td>{{ ad.conversions }}</td>
                            <td>{{ ad.reason }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const checkButton = document.getElementById('checkButton');
        const loaderContainer = document.getElementById('loaderContainer');
        const resultsContainer = document.getElementById('resultsContainer');
        
        // Если есть результаты, показываем их сразу
        {% if results %}
        resultsContainer.style.display = 'block';
        {% endif %}
        
        checkButton.addEventListener('click', function() {
            // Показываем индикатор загрузки
            loaderContainer.style.display = 'block';
            resultsContainer.style.display = 'none';
            checkButton.disabled = true;
            
            // Выполняем запрос на проверку кампании
            const campaignId = "{{ campaign_id if campaign_id else campaign.id if campaign }}";
            
            fetch(`/campaigns/check/${campaignId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сети: ' + response.status);
                }
                return response.text();
            })
            .then(html => {
                // Обновляем страницу с новыми результатами
                window.location.reload();
            })
            .catch(error => {
                alert('Ошибка при проверке кампании: ' + error.message);
            })
            .finally(() => {
                // Скрываем индикатор загрузки
                loaderContainer.style.display = 'none';
                checkButton.disabled = false;
            });
        });
    });
</script>
{% endblock %} 