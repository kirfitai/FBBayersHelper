{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Список конверсий</h1>
    
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>Фильтры</h5>
                </div>
                <div class="card-body">
                    <form method="get" action="{{ url_for('main.conversions_list') }}">
                        <div class="row">
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label for="ref_prefix" class="form-label">Префикс REF</label>
                                    <select class="form-select" id="ref_prefix" name="ref_prefix">
                                        <option value="">Все</option>
                                        {% for prefix in unique_prefixes %}
                                        <option value="{{ prefix }}" {% if ref_prefix == prefix %}selected{% endif %}>{{ prefix }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label for="form_id" class="form-label">Form ID</label>
                                    <select class="form-select" id="form_id" name="form_id">
                                        <option value="">Все</option>
                                        {% for form in unique_form_ids %}
                                        <option value="{{ form }}" {% if form_id == form %}selected{% endif %}>{{ form }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label for="ref" class="form-label">REF</label>
                                    <input type="text" class="form-control" id="ref" name="ref" value="{{ ref }}">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label for="quid" class="form-label">QUID</label>
                                    <input type="text" class="form-control" id="quid" name="quid" value="{{ quid }}">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label for="start_date" class="form-label">С даты</label>
                                    <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date }}">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label for="end_date" class="form-label">По дату</label>
                                    <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date }}">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="per_page" class="form-label">Записей на странице</label>
                                    <select class="form-select" id="per_page" name="per_page">
                                        <option value="10" {% if conversions.per_page == 10 %}selected{% endif %}>10</option>
                                        <option value="25" {% if conversions.per_page == 25 %}selected{% endif %}>25</option>
                                        <option value="50" {% if conversions.per_page == 50 %}selected{% endif %}>50</option>
                                        <option value="100" {% if conversions.per_page == 100 %}selected{% endif %}>100</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <div class="mb-3">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-search"></i> Применить фильтры
                                    </button>
                                    <a href="{{ url_for('main.conversions_list') }}" class="btn btn-secondary">
                                        <i class="fas fa-times"></i> Сбросить
                                    </a>
                                    <a href="{{ url_for('main.conversions_page') }}" class="btn btn-outline-primary">
                                        <i class="fas fa-chart-bar"></i> К аналитике
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>Конверсии {% if conversions and conversions.total %}(всего: {{ conversions.total }}){% endif %}</h5>
                    {% if conversions and conversions.pages > 1 %}
                    <span>Страница {{ conversions.page }} из {{ conversions.pages }}</span>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if conversions and conversions.items %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Дата и время</th>
                                    <th>REF</th>
                                    <th>Префикс</th>
                                    <th>Form ID</th>
                                    <th>QUID</th>
                                    <th>IP адрес</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for conversion in conversions.items %}
                                <tr>
                                    <td>{{ conversion.id }}</td>
                                    <td>{{ conversion.timestamp.strftime('%d.%m.%Y %H:%M:%S') }}</td>
                                    <td>{{ conversion.ref }}</td>
                                    <td><span class="badge bg-primary">{{ conversion.ref_prefix }}</span></td>
                                    <td>{{ conversion.form_id }}</td>
                                    <td>{{ conversion.quid }}</td>
                                    <td>{{ conversion.ip_address }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    {% if conversions.pages > 1 %}
                    <nav aria-label="Pagination">
                        <ul class="pagination justify-content-center">
                            {% if conversions.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('main.conversions_list', page=conversions.prev_num, per_page=conversions.per_page, ref=ref, ref_prefix=ref_prefix, form_id=form_id, quid=quid, start_date=start_date, end_date=end_date) }}">
                                    &laquo; Предыдущая
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <a class="page-link" href="#">&laquo; Предыдущая</a>
                            </li>
                            {% endif %}
                            
                            {% for page_num in range(max(1, conversions.page - 2), min(conversions.pages + 1, conversions.page + 3)) %}
                            <li class="page-item {% if page_num == conversions.page %}active{% endif %}">
                                <a class="page-link" href="{{ url_for('main.conversions_list', page=page_num, per_page=conversions.per_page, ref=ref, ref_prefix=ref_prefix, form_id=form_id, quid=quid, start_date=start_date, end_date=end_date) }}">
                                    {{ page_num }}
                                </a>
                            </li>
                            {% endfor %}
                            
                            {% if conversions.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('main.conversions_list', page=conversions.next_num, per_page=conversions.per_page, ref=ref, ref_prefix=ref_prefix, form_id=form_id, quid=quid, start_date=start_date, end_date=end_date) }}">
                                    Следующая &raquo;
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <a class="page-link" href="#">Следующая &raquo;</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                    {% else %}
                    <div class="alert alert-info">
                        <p class="mb-0">Нет конверсий, соответствующих заданным критериям.</p>
                        <p class="mt-2 mb-0">
                            <a href="{{ url_for('main.add_test_conversion') }}" class="btn btn-sm btn-primary">Добавить тестовую конверсию</a>
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} 